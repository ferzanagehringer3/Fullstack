<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DalZana Connect</title>
  <link rel="stylesheet" th:href="@{/css/layout.css}">
  <link rel="stylesheet" th:href="@{/css/main.css}">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f6f7fb;
      padding-top: 64px;
    }

    .app {
      height: calc(100vh - 64px);
      display: flex;
      overflow: hidden;

    }

    /* SIDEBAR */
    .left {
      position: sticky;
      top: 64px;
      height: calc(100vh - 64px);
      flex: 0 0 260px;
      width: 260px;
      min-width: 260px;
      border-right: 1px solid #e5e7eb;
      padding: 20px;
      overflow-y: auto;
      overflow-x: hidden;
      background: #fff;
      transition: width 0.3s ease, flex-basis 0.3s ease, padding 0.3s ease;
    }

    /* collapsed = schmale Leiste (Toggle bleibt sichtbar) */
    .left.collapsed {
      flex-basis: 64px;
      width: 64px;
      min-width: 64px;
      padding: 12px 10px;
      border-right: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .sidebar-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 16px;
    }

    .sidebar-head h3 {
      margin: 0;
      font-size: 18px;
      color: #111827;
    }

    .left.collapsed .sidebar-head {
      justify-content: center;
      margin-bottom: 0;
    }

    .left.collapsed .sidebar-head h3 {
      display: none;
    }

    .sidebar-content {
      display: block;
    }

    .left.collapsed .sidebar-content {
      display: none;
    }

    .toggle-sidebar-btn {
      padding: 8px 12px;
      border: 1px solid #dc3545;
      border-radius: 6px;
      cursor: pointer;
      background: #dc3545;
      color: #fff;
      font-size: 20px;
      font-weight: bold;
      transition: all 0.2s;
    }

    .toggle-sidebar-btn:hover {
      background: #c82333;
      border-color: #c82333;
      color: #fff;
    }

    .create-btn {
      width: 100%;
      padding: 12px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }

    .create-btn:hover {
      background: #2563eb;
    }

    .teams .team-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
    }

    .teams button.team {
      flex: 1;
      padding: 10px 12px;
      text-align: left;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      color: #374151;
      position: relative;
    }

    .teams button.team:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .teams .team-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      background: #dc3545;
      border-radius: 50%;
      width: 12px;
      height: 12px;
      display: none;
      animation: pulse 1s infinite;
    }

    /* Wrapper um den Chat: nimmt den restlichen Platz in .main ein */
    .add-member {
      flex: 1;
      min-height: 0;
      display: flex;
    }

    /* Chat ist der einzige Scrollbereich */
    .add-member .chat {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
    }

    /* MAIN / CHAT */
    .main {
      flex: 1;
      padding: 24px;
      display: flex;
      flex-direction: column;
      background: #f6f7fb;
      min-width: 0;
      height: 100%;
      overflow: hidden;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 16px;
      gap: 16px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .team-title {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    .team-title h2 {
      margin: 0;
      font-size: 20px;
      color: #111827;
      word-break: break-word;
    }

    .team-members {
      font-size: 13px;
      color: #6b7280;
    }

    .team-members a {
      color: #3b82f6;
      text-decoration: none;
    }

    .team-members a:hover {
      text-decoration: underline;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
      flex-wrap: wrap;
    }

    .header-actions button,
    .header-actions a button {
      padding: 8px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      cursor: pointer;
      background: #fff;
      color: #374151;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .header-actions button:hover,
    .header-actions a button:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    .chat {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #fff;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }

    .msg {
      padding: 12px 16px;
      border-radius: 8px;
      max-width: 50%;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .msg.sent {
      align-self: flex-end;
      background: #3b82f6;
      color: #fff;
      border-radius: 8px 0 8px 8px;
    }

    .msg.received {
      align-self: flex-start;
      background: #e5e7eb;
      color: #111827;
      border-radius: 0 8px 8px 8px;
    }

    .msg-sender {
      font-size: 12px;
      font-weight: 600;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .msg.new-message {
      animation: highlight 2s ease-out;
    }

    @keyframes highlight {
      from {
        background: #fef3c7;
      }

      to {
        background: transparent;
      }
    }

    .composer {
      display: flex;
      gap: 10px;
      border-top: 1px solid #e5e7eb;
      padding: 16px 24px;
      background: #fff;
      /* KEIN sticky -> nimmt Platz ein und schiebt den Chat nach oben */
    }

    input[type="text"] {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
      min-width: 0;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .composer textarea {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
      font-family: 'Segoe UI', Arial, sans-serif;
      min-width: 0;
      min-height: 42px;
      max-height: 200px;
      resize: vertical;
      line-height: 1.5;
    }

    .composer textarea:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .composer button {
      padding: 10px 20px;
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .composer button:hover {
      background: #2563eb;
    }

    .message {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .message.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .message.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    /* Accordion */
    .accordion {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .acc-item {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
    }

    .acc-trigger {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      background: #f9fafb;
      border: 0;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }

    .acc-trigger:hover {
      background: #f3f4f6;
    }

    .acc-icon {
      transition: transform 0.2s ease;
    }

    .acc-item.open .acc-icon {
      transform: rotate(180deg);
    }

    .acc-panel {
      display: none;
      padding: 10px 12px 12px 12px;
    }

    .acc-item.open .acc-panel {
      display: block;
    }

    /* Requests list look */
    .request-row {
      margin: 8px 0;
    }

    .request-item {
      padding: 10px 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
    }

    .request-title {
      font-size: 14px;
      color: #374151;
      font-weight: 500;
    }

    .request-meta {
      margin-top: 4px;
      font-size: 12px;
      color: #6b7280;
    }

    /* Wenn Sidebar collapsed: Inhalt ausblenden (wie bei dir) */
    .left.collapsed .sidebar-content {
      display: none;
    }
  </style>
</head>

<body>
  <div th:insert="~{fragments/header}"></div>

  <div class="app">
    <!-- LEFT: Teams -->
    <div th:replace="~{fragments/sidebar}"></div>

    <!-- CENTER: Chat -->
    <div class="main">
      <div th:if="${successMessage}" class="message success" th:text="${successMessage}"></div>
      <div th:if="${errorMessage}" class="message error" th:text="${errorMessage}"></div>

      <div class="header">
        <div class="team-title">
          <h2 id="teamTitle" th:if="${!#lists.isEmpty(teams)}">
            <span th:text="${teams[0].name}">Team</span>
            <span th:if="${teams[0].request}" style="color: #6b7280; font-size: 16px;"
              th:text="' - Request: ' + ${teams[0].request.title}"></span>
          </h2>
          <h2 id="teamTitle" th:if="${#lists.isEmpty(teams)}">Kein Team</h2>

          <div class="team-members" th:if="${!#lists.isEmpty(teams)}">
            <a id="teamMembersLink" th:href="@{/teams/{id}(id=${teams[0].id})}"
              th:text="${#strings.listJoin(teams[0].members.![name], ', ')}">Mitglieder</a>
          </div>
          <div class="team-members" th:if="${#lists.isEmpty(teams)}">Keine Mitglieder</div>
        </div>

        <div class="header-actions">

          <a id="filesLink" th:if="${!#lists.isEmpty(teams)}" th:href="@{/teams/{teamId}/files(teamId=${teams[0].id})}"
            style="text-decoration: none;">
            <button id="filesBtn">Files</button>
          </a>
          <button id="filesBtn" th:if="${#lists.isEmpty(teams)}" disabled>Files</button>

        </div>
      </div>

      <div class="add-member" th:if="${!#lists.isEmpty(teams)}">
        <div class="chat" id="chatBox">
          <!-- Messages will be loaded here -->
        </div>
      </div>

      <form class="composer" id="chatForm" th:if="${!#lists.isEmpty(teams)}">
        <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
        <button type="submit">Send</button>
      </form>

      <div th:if="${#lists.isEmpty(teams)}" style="text-align: center; color: #999; padding: 20px;">
        Keine Teams vorhanden - erstelle ein Team um zu chatten
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    let currentTeamId = null;
    let messageInterval = null;
    let teamLastMessageCount = {}; // Track message count per team
    const currentUserName = /*[[${currentUserName}]]*/ 'Unknown';

    // Initialize with first team if available
    const teams = document.querySelectorAll('.team');
    if (teams.length > 0) {
      const firstTeam = teams[0];
      currentTeamId = firstTeam.dataset.teamId;

      // Initialize message counts for all teams
      teams.forEach(team => {
        const teamId = team.dataset.teamId;
        teamLastMessageCount[teamId] = 0;
      });

      loadMessages();
      startMessagePolling();
    }

    // Switch team title + files link + chat
    document.getElementById("teamList")?.addEventListener("click", (e) => {
      const btn = e.target.closest(".team");
      if (!btn) return;

      const teamName = btn.dataset.teamName;
      const teamId = btn.dataset.teamId;
      const teamMembers = btn.dataset.teamMembers || '';
      const requestTitle = btn.dataset.requestTitle || '';

      currentTeamId = teamId;

      if (teamName) {
        const titleElement = document.getElementById("teamTitle");
        titleElement.innerHTML = teamName;
        if (requestTitle) {
          titleElement.innerHTML += '<span style="color: #6b7280; font-size: 16px;"> - Request: ' + requestTitle + '</span>';
        }
      }

      const filesLink = document.getElementById("filesLink");
      if (filesLink && teamId) {
        filesLink.setAttribute("href", `/teams/${teamId}/files`);
      }

      const membersLink = document.getElementById("teamMembersLink");
      if (membersLink && teamId) {
        membersLink.setAttribute("href", `/teams/${teamId}`);
        membersLink.textContent = teamMembers || 'Keine Mitglieder';
      }

      loadMessages();
      updateTeamBadge(teamId, false);
    });

    // Send message
    document.getElementById("chatForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text || !currentTeamId) return;

      try {
        const formData = new URLSearchParams();
        formData.append('teamId', currentTeamId);
        formData.append('content', text);

        const response = await fetch('/home/messages/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formData
        });

        if (response.ok) {
          input.value = "";
          input.style.height = 'auto'; // Reset textarea height
          await loadMessages();
          // Ensure scroll to bottom after messages loaded
          setTimeout(() => {
            const chatBox = document.getElementById("chatBox");
            if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
          }, 100);
        }
      } catch (error) {
        console.error('Error sending message:', error);
      }
    });

    // Load messages for current team
    async function loadMessages() {
      if (!currentTeamId) return;

      try {
        const response = await fetch(`/home/messages/${currentTeamId}`);
        const messages = await response.json();

        const chatBox = document.getElementById("chatBox");
        if (!chatBox) return;

        // Store scroll position to check if user was at bottom
        const wasAtBottom = chatBox.scrollHeight - chatBox.scrollTop <= chatBox.clientHeight + 50;

        chatBox.innerHTML = '';

        messages.forEach(msg => {
          const msgDiv = document.createElement("div");
          const isSent = (msg.senderName || '').trim().toLowerCase() === (currentUserName || '').trim().toLowerCase();

          msgDiv.className = `msg ${isSent ? 'sent' : 'received'}`;

          let html = '';
          if (!isSent) {
            html += `<div class="msg-sender">${msg.senderName}</div>`;
          }
          html += msg.content;
          msgDiv.innerHTML = html;

          chatBox.appendChild(msgDiv);
        });

        teamLastMessageCount[currentTeamId] = messages.length;

        // Scroll to bottom if user was already at bottom or on first load
        if (wasAtBottom || messages.length > 0) {
          requestAnimationFrame(() => {
            chatBox.scrollTop = chatBox.scrollHeight;
          });
        }
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }

    async function checkAllTeamsForMessages() {
      const teamButtons = document.querySelectorAll('.team');

      for (const teamBtn of teamButtons) {
        const teamId = teamBtn.dataset.teamId;
        if (!teamId) continue;

        try {
          const response = await fetch(`/home/messages/${teamId}`);
          const messages = await response.json();

          const previousCount = teamLastMessageCount[teamId] || 0;
          const currentCount = messages.length;

          let hasNewMessagesFromOthers = false;
          if (currentCount > previousCount) {
            for (let i = previousCount; i < currentCount; i++) {
              if (messages[i].senderName !== currentUserName) {
                hasNewMessagesFromOthers = true;
                break;
              }
            }
          }

          if (teamId != currentTeamId && hasNewMessagesFromOthers) {
            updateTeamBadge(teamId, true);
            playNotificationSound();
          }
        } catch (error) {
          console.error(`Error checking messages for team ${teamId}:`, error);
        }
      }
    }

    function updateTeamBadge(teamId, show) {
      const teamBtn = document.querySelector(`.team[data-team-id="${teamId}"]`);
      if (!teamBtn) return;

      let badge = teamBtn.querySelector('.team-badge');

      if (show) {
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'team-badge';
          teamBtn.appendChild(badge);
        }
        badge.style.display = 'block';
      } else {
        if (badge) badge.style.display = 'none';
      }
    }

    function playNotificationSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (error) {
        console.log('Audio notification not available');
      }
    }

    function startMessagePolling() {
      if (messageInterval) clearInterval(messageInterval);
      messageInterval = setInterval(() => {
        loadMessages();
        checkAllTeamsForMessages();
      }, 2000);
    }

    // Sidebar toggle + restore
    document.addEventListener("DOMContentLoaded", () => {
      const sidebar = document.querySelector(".left");
      const btn = document.getElementById("toggleSidebarBtn");
      if (!sidebar || !btn) return;

      function applyState(collapsed) {
        sidebar.classList.toggle("collapsed", collapsed);
        btn.setAttribute("aria-expanded", String(!collapsed));
      }

      applyState(localStorage.getItem("sidebarCollapsed") === "true");

      btn.addEventListener("click", () => {
        const collapsed = !sidebar.classList.contains("collapsed");
        applyState(collapsed);
        localStorage.setItem("sidebarCollapsed", String(collapsed));
      });

      // Accordion functionality
      const accordion = document.getElementById("sidebarAccordion");
      if (accordion) {
        const triggers = accordion.querySelectorAll(".acc-trigger");

        triggers.forEach(trigger => {
          trigger.addEventListener("click", () => {
            const item = trigger.closest(".acc-item");
            if (!item) return;

            // Toggle current item
            item.classList.toggle("open");
            const isOpen = item.classList.contains("open");
            trigger.setAttribute("aria-expanded", String(isOpen));
          });
        });
      }
    });
  </script>
</body>

</html>