<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DalZana Connect</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    .app { height: 100vh; display: flex; }
    .left { width: 240px; border-right: 1px solid #ddd; padding: 12px; overflow-y: auto; }
    .main { flex: 1; padding: 12px; display: flex; flex-direction: column; }
    .teams .team-row { display: flex; align-items: center; gap: 6px; margin: 6px 0; }
    .teams button.team { flex: 1; padding: 8px; text-align: left; position: relative; }
    .teams .team-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      background: #dc3545;
      border-radius: 50%;
      width: 12px;
      height: 12px;
      display: none;
      animation: pulse 1s infinite;
    }
    .teams .team-actions { display: flex; gap: 4px; }
    .teams .team-actions a, .teams .team-actions button { padding: 6px 8px; font-size: 12px; }
    .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 10px; gap: 12px; }
    .team-title { display: flex; flex-direction: column; gap: 4px; }
    .team-members { font-size: 12px; color: #888; }
    .team-members a { color: #888; text-decoration: none; }
    .team-members a:hover { text-decoration: underline; }
    .header-actions { display: flex; align-items: center; gap: 8px; margin-left: auto; }
    .chat { flex: 1; padding: 12px 0; overflow: auto; }
    .msg { margin: 6px 0; }
    .msg.new-message { background: #fff3cd; padding: 4px; border-radius: 4px; animation: highlight 2s ease-out; }
    @keyframes highlight { from { background: #fff3cd; } to { background: transparent; } }
    .composer { display: flex; gap: 8px; border-top: 1px solid #ddd; padding-top: 10px; }
    input[type="text"] { flex: 1; padding: 8px; }
    .form-group { margin: 12px 0; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 4px; }
    .form-group input, .form-group select { width: 100%; padding: 6px; box-sizing: border-box; }
    .form-group button { background: #28a745; color: #fff; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-top: 8px; }
    .form-group button:hover { background: #218838; }
    .message { padding: 10px; border-radius: 4px; margin-bottom: 10px; }
    .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .create-team { background: #f5f5f5; padding: 12px; border-radius: 4px; margin-bottom: 12px; }
    .add-member { background: #f5f5f5; padding: 12px; border-radius: 4px; margin-bottom: 12px; }
  </style>
</head>

<body>
  <div class="app">
    <!-- LEFT: Teams -->
    <div class="left">
      <h3>Teams</h3>

      <!-- Create Team Button -->
      <div th:if="${currentUserRole == 'MANAGER'}" style="margin-bottom: 12px;">
        <a href="/teams/create" style="text-decoration: none;">
          <button style="width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
            + Neues Team erstellen
          </button>
        </a>
      </div>

      <!-- Team List -->
      <div class="teams" id="teamList">
        <div th:if="${#lists.isEmpty(teams)}">Keine Teams vorhanden</div>
        <div th:each="t : ${teams}" class="team-row">
          <button class="team"
                  th:data-team-id="${t.id}"
                  th:data-team-name="${t.name}"
                  th:data-team-members="${#strings.listJoin(t.members.![name], ', ')}"
                  th:text="${t.name}">
            Team
          </button>
          <div th:if="${currentUserRole == 'MANAGER'}" class="team-actions">
            <a th:href="@{/teams/{id}/edit(id=${t.id})}" style="text-decoration:none;">
              <button type="button">Bearbeiten</button>
            </a>
            <form th:action="@{/teams/{id}/delete(id=${t.id})}" method="post" onsubmit="return confirm('Team wirklich löschen?');">
              <button type="submit" style="background:#dc3545;color:#fff;border:none;border-radius:4px;">Löschen</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- CENTER: Chat -->
    <div class="main">
      <div th:if="${successMessage}" class="message success" th:text="${successMessage}"></div>
      <div th:if="${errorMessage}" class="message error" th:text="${errorMessage}"></div>

      <div class="header">
        <div class="team-title">
          <h2 id="teamTitle" th:if="${!#lists.isEmpty(teams)}" th:text="${teams[0].name}">Team</h2>
          <h2 id="teamTitle" th:if="${#lists.isEmpty(teams)}">Kein Team</h2>

          <div class="team-members" th:if="${!#lists.isEmpty(teams)}">
            <a id="teamMembersLink"
               th:href="@{/teams/{id}(id=${teams[0].id})}"
               th:text="${#strings.listJoin(teams[0].members.![name], ', ')}">Mitglieder</a>
          </div>
          <div class="team-members" th:if="${#lists.isEmpty(teams)}">Keine Mitglieder</div>
        </div>

        <div class="header-actions">
          <a id="profileLink" th:href="@{/profile}" style="text-decoration: none;">
            <button id="profileBtn">Mein Profil</button>
          </a>
          <a id="filesLink"
             th:if="${!#lists.isEmpty(teams)}"
             th:href="@{/teams/{teamId}/files(teamId=${teams[0].id})}"
             style="text-decoration: none;">
            <button id="filesBtn">Files</button>
          </a>
          <button id="filesBtn" th:if="${#lists.isEmpty(teams)}" disabled>Files</button>

          <a id="logoutLink" th:href="@{/logout}" style="text-decoration: none;">
            <button id="logoutBtn">Logout</button>
          </a>
        </div>
      </div>

      <!-- Add Member Form -->
      <div class="add-member" th:if="${!#lists.isEmpty(teams)}">
        <div class="chat" id="chatBox">
          <!-- Messages will be loaded here -->
        </div>
      </div>

      <form class="composer" id="chatForm" th:if="${!#lists.isEmpty(teams)}">
        <input id="messageInput" type="text" placeholder="Type a message..." />
        <button type="submit">Send</button>
      </form>
      <div th:if="${#lists.isEmpty(teams)}" style="text-align: center; color: #999; padding: 20px;">
        Keine Teams vorhanden - erstelle ein Team um zu chatten
      </div>
    </div>
  </div>



  <script>
    let currentTeamId = null;
    let messageInterval = null;
    let teamLastMessageCount = {}; // Track message count per team
    const currentUserName = /*[[${currentUserName}]]*/ 'Unknown';

    // Initialize with first team if available
    const teams = document.querySelectorAll('.team');
    if (teams.length > 0) {
      const firstTeam = teams[0];
      currentTeamId = firstTeam.dataset.teamId;
      
      // Initialize message counts for all teams
      teams.forEach(team => {
        const teamId = team.dataset.teamId;
        teamLastMessageCount[teamId] = 0;
      });
      
      loadMessages();
      startMessagePolling();
    }

    // Switch team title + files link + chat
    document.getElementById("teamList").addEventListener("click", (e) => {
      const btn = e.target.closest(".team");
      if (!btn) return;

      const teamName = btn.dataset.teamName;
      const teamId = btn.dataset.teamId;
      const teamMembers = btn.dataset.teamMembers || '';

      currentTeamId = teamId;

      if (teamName) {
        document.getElementById("teamTitle").textContent = teamName;
      }

      const filesLink = document.getElementById("filesLink");
      if (filesLink && teamId) {
        filesLink.setAttribute("href", `/teams/${teamId}/files`);
      }

      const membersLink = document.getElementById("teamMembersLink");
      if (membersLink && teamId) {
        membersLink.setAttribute("href", `/teams/${teamId}`);
        membersLink.textContent = teamMembers || 'Keine Mitglieder';
      }

      // Load messages for new team
      loadMessages();
      
      // Clear badge for current team
      updateTeamBadge(teamId, false);
    });

    // Send message
    document.getElementById("chatForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text || !currentTeamId) return;

      try {
        const formData = new URLSearchParams();
        formData.append('teamId', currentTeamId);
        formData.append('content', text);

        const response = await fetch('/home/messages/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formData
        });

        if (response.ok) {
          input.value = "";
          loadMessages();
        }
      } catch (error) {
        console.error('Error sending message:', error);
      }
    });

    // Load messages for current team
    async function loadMessages() {
      if (!currentTeamId) return;

      try {
        const response = await fetch(`/home/messages/${currentTeamId}`);
        const messages = await response.json();

        const chatBox = document.getElementById("chatBox");
        chatBox.innerHTML = '';

        messages.forEach(msg => {
          const msgDiv = document.createElement("div");
          msgDiv.className = "msg";
          msgDiv.innerHTML = `<b>${msg.senderName}:</b> ${msg.content}`;
          chatBox.appendChild(msgDiv);
        });

        // Update last seen count for current team
        teamLastMessageCount[currentTeamId] = messages.length;
        
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }

    // Check all teams for new messages
    async function checkAllTeamsForMessages() {
      const teamButtons = document.querySelectorAll('.team');
      
      for (const teamBtn of teamButtons) {
        const teamId = teamBtn.dataset.teamId;
        if (!teamId) continue;
        
        try {
          const response = await fetch(`/home/messages/${teamId}`);
          const messages = await response.json();
          
          const previousCount = teamLastMessageCount[teamId] || 0;
          const currentCount = messages.length;
          
          // Check if there are new messages from OTHER users
          let hasNewMessagesFromOthers = false;
          if (currentCount > previousCount) {
            for (let i = previousCount; i < currentCount; i++) {
              if (messages[i].senderName !== currentUserName) {
                hasNewMessagesFromOthers = true;
                break;
              }
            }
          }
          
          // Only show badge for teams OTHER than the current one
          if (teamId != currentTeamId && hasNewMessagesFromOthers) {
            updateTeamBadge(teamId, true);
            playNotificationSound();
          }
          
        } catch (error) {
          console.error(`Error checking messages for team ${teamId}:`, error);
        }
      }
    }

    // Update badge (show/hide red dot)
    function updateTeamBadge(teamId, show) {
      const teamBtn = document.querySelector(`.team[data-team-id="${teamId}"]`);
      if (!teamBtn) return;
      
      let badge = teamBtn.querySelector('.team-badge');
      
      if (show) {
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'team-badge';
          teamBtn.appendChild(badge);
        }
        badge.style.display = 'block';
      } else {
        if (badge) {
          badge.style.display = 'none';
        }
      }
    }

    // Simple notification sound
    function playNotificationSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (error) {
        console.log('Audio notification not available');
      }
    }

    // Poll for new messages every 2 seconds
    function startMessagePolling() {
      if (messageInterval) clearInterval(messageInterval);
      messageInterval = setInterval(() => {
        loadMessages(); // Reload current team messages
        checkAllTeamsForMessages(); // Check all teams for badges
      }, 2000);
    }

    // Files button links to selected team
  </script>
</body>
</html>
